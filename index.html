<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Typing 9</title>
    <style>
      :root {
        --light-grey: #ddd;
        --light-blue: #ccf;
        --dark-grey: #222;
        --light-green: #7c8;
        --light-red: #c76;
        font-size: 30px;
      }
      .cursor {
        border: solid 4px blue;
        border-radius: 8px;
      }

      @media (max-width: 600px) {
        body {
          font-size: 50px;
          background-color: blue;
          color: white;
        }
        .inp {
          width: 50%;
          height: 70px;
          font-size: 40px;
        }
        .btn {
          width: 50%;
          height: 70px;
          font-size: 40px;
        }
        .cursor {
          border: solid 4px orange;
          border-radius: 8px;
        }
      }
      .letter {
        font-size: 50px;

        width: 50px;
        height: 80px;
        margin: 2px;
        padding: 4px;
        border-radius: 4px;
        background-color: var(--light-grey);
        color: var(--dark-grey);
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .letter:focus {
        border: 4px solid gold;
      }
      .all-box {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .output-box {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        margin-top: 20px;
        margin-bottom: 20px;
      }
      /*
      .inp {
        width: 50%;
        height: 70px;
        font-size: 40px;
      }

      .btn {
        width: 50%;
        height: 70px;
        font-size: 40px;
      }
        */

      .correct {
        background-color: var(--light-green);
      }
      .wrong {
        background-color: var(--light-red);
      }
    </style>
  </head>
  <body>
    <div id="all-box" class="all-box">
      Hint: Do you understand?
      <div class="output-box" id="output-box"></div>
      <input type="text" id="inp-1" class="inp" />
      <button class="btn" id="btn-audio" type="submit">Play Audio</button>
    </div>
    <script>
      //BIG REFACTOR.. have one input at the bottom and the rest are divs that respond to input on inp-1
      let word = "I hope you understand.";
      let wordObj = {};
      let cursorPos = 0;
      let focusPos = 0;
      document.addEventListener("DOMContentLoaded", function (e) {
        //console.log(window.matchMedia("(max-width: 600px)"));
        //0--build word object
        alert("opened");

        wordObj = {};
        for (let i = 0; i < word.length; i++) {
          //
          wordObj[i] = word[i];
        }
        console.log(wordObj);
        //1--word loaded to screen
        for (let i = 0; i < word.length; i++) {
          //
          let outputDiv = document.querySelector("#output-box");
          let letterDiv = document.createElement("div");
          letterDiv.setAttribute("id", "ltr-" + i);

          letterDiv.classList.add("letter");
          //

          outputDiv.appendChild(letterDiv);
        }

        document.querySelector("#ltr-0").classList.add("cursor");
        document.querySelector("#inp-1").focus();
        //2--on key press down, letter added and css for correct or false letter added
        //const regex = /^[a-zA-z0-9"!@#$%^&*()-_+=,./<>?|`\s]/;
        //ensure it has only the specified characters...
        const regex = /^[^a-zA-Z0-9,.;:'"!@#$%^&*()-_+=\s]+$/;

        document
          .querySelector("#inp-1")
          .addEventListener("textInput", function (e) {
            //-- check if keykode is 0 or 229.
            //check if last character entered, at current position, is the same as the letter at position in target phrase
            //1--get letter.
            console.log(`e.data: ${e.data}`);

            //

            //

            let index = this.selectionStart;
            let indexEnd = this.selectionEnd;

            if (index > indexEnd) {
              let tmpNum = index;
              index = indexEnd;
              indexEnd = tmpNum;
            }
            let iDiff = Math.abs(index - indexEnd);
            console.log(iDiff);

            let isTooLongIndex = false;
            let ltr = "";
            let ltrId = "";
            let val = document.querySelector("#inp-1").value;
            if (index < Object.keys(wordObj).length) {
              ltr = wordObj[index];
              console.log(wordObj[index]);
              ltrId = "ltr-" + index;
            } else {
              isTooLongIndex = true;
            }

            //
            if (isTooLongIndex) {
              e.preventDefault();
              updateOutput("inp-1", "output-box", val);
              removeRightAndWrong("output-box");
              addRightAndWrong(val, "output-box", wordObj);
              console.log("exiting");
              return;
            }
            if (iDiff > 0) {
              val = val.slice(0, index) + val.slice(indexEnd, val.length);
              console.log(val);
            }
            //if val == length of wordObj, do not allow new val to be created...

            let newVal =
              val.slice(0, index) + e.data + val.slice(index, val.length);
            console.log(newVal);
            if (newVal.length > Object.keys(wordObj).length) {
              e.preventDefault();
              return;
            }
            updateOutput("inp-1", "output-box", newVal);
            removeRightAndWrong("output-box");
            addRightAndWrong(val, "output-box", wordObj);

            if (index + 1 <= Object.keys(wordObj).length) {
              if (index + 1 == Object.keys(wordObj).length) {
                //cursor does not change
              } else {
                // you can change the cursor
                removeAllCursor("output-box");
                let newLtrId = "ltr-" + String(index + 1);
                document.querySelector("#" + newLtrId).classList.add("cursor");
              }
            } else {
              //preventDefault... adding text to input? or clear input...
              e.preventDefault();
              alert("prevent default");
              alert(
                `index: ${index} wordObj.length ${Object.keys(wordObj).length}`
              );
            }
          });
        //detect a backspace or other key
        document
          .querySelector("#inp-1")
          .addEventListener("keydown", function (e) {
            //alert(`key: ${e.key},  code: ${e.code} `);
            console.log(`e.key: ${e.key}`);
            console.log("start: " + this.selectionStart);
            console.log("end: " + this.selectionEnd);

            let val = document.querySelector("#inp-1").value;

            //TODO NEXT... continue developing for android.. if e.key = 229 or e.key == 0, (how many keys have this code?.. for backspace.... RESEARCH)
            //1--check at selection start if key entered is the same
            if (String(e.key).length > 1) {
              //if e.key is longer than 1 length, do not update value... exit
              //if it is a backspace, refresh cursor and output, remove a letter at cursor
              if (e.key == "Backspace") {
                let newVal = "";
                let index = this.selectionStart;
                let indexEnd = this.selectionEnd;

                if (index > indexEnd) {
                  let tmpNum = index;
                  index = indexEnd;
                  indexEnd = tmpNum;
                }
                let iDiff = Math.abs(index - indexEnd);

                if (val.length > 0) {
                  if (indexEnd == val.length && iDiff == 0) {
                    newVal = val.slice(0, indexEnd - 1);
                    console.log(newVal);
                  } else if (index == indexEnd) {
                    console.log(
                      `hey 2, indexEnd: ${indexEnd} , valLength: ${val.length}`
                    );
                    //IF INDEX and INDEX END ARE THE SAME
                    newVal =
                      val.slice(0, index - 1) + val.slice(indexEnd, val.length);
                    console.log(newVal);
                  } else {
                    console.log("iDiff:" + iDiff);
                    console.log(
                      `hey 3, indexEnd: ${indexEnd} , valLength: ${val.length}`
                    );
                    //IF INDEX and INDEX END ARE not THE SAME
                    newVal =
                      val.slice(0, index) + val.slice(indexEnd, val.length);
                    console.log(newVal);
                  }

                  updateOutput("inp-1", "output-box", newVal);
                  removeRightAndWrong("output-box");
                  addRightAndWrong(val, "output-box", wordObj);

                  if (this.selectionStart >= word.length) {
                    ltrId = "ltr-" + Number(this.selectionStart - 1);
                    //alert("a");
                  } else if (iDiff > 0) {
                    //
                    ltrId = "ltr-" + Number(this.selectionStart);
                    //alert("b");
                  } else {
                    ltrId = "ltr-" + this.selectionStart;
                    //alert("c");
                  }

                  removeAllCursor("output-box");
                  let newLtrId = ltrId;
                  if (index > 0 && iDiff > 0) {
                    newLtrId = "ltr-" + String(this.selectionStart);
                  } else if (index > 0 && iDiff == 0) {
                    //
                    newLtrId = "ltr-" + String(this.selectionStart - 1);
                  }
                  document
                    .querySelector("#" + newLtrId)
                    .classList.add("cursor");
                }
                //b-- move cursor back 1
              } else if (e.key == "ArrowLeft") {
                //... get current position and move the position one back
                let index = this.selectionStart;
                let ltrId = "ltr-" + String(index);
                let newLtrId = ltrId;
                if (index > 0) {
                  //
                  newLtrId = "ltr-" + String(index - 1);
                }

                //TODO NEXT -- add this new function anywhere there is a remove cursor
                removeAllCursor("output-box");

                document.querySelector("#" + newLtrId).classList.add("cursor");
              } else if (e.key == "ArrowRight") {
                //... get current position and move the position one back
                let index = this.selectionStart;
                let ltrId = "ltr-" + String(index);
                let newLtrId = ltrId;
                if (index < word.length - 1 && index < val.length) {
                  //DONE... IF it is the last letter in val.. only this far....
                  newLtrId = "ltr-" + String(index + 1);
                  removeAllCursor("output-box");

                  document
                    .querySelector("#" + newLtrId)
                    .classList.add("cursor");
                }
              } else if (e.key == "ArrowUp") {
                //Go to index 0 of the outputbox...
                //
                removeAllCursor("output-box");
                ltrId = "ltr-0";
                document.querySelector("#" + ltrId).classList.add("cursor");
              } else if (e.key == "ArrowDown") {
                //Go to index after last val digit
                //
                removeAllCursor("output-box");
                if (val.length >= word.length) {
                  ltrId = "ltr-" + Number(val.length - 1);
                } else {
                  ltrId = "ltr-" + val.length;
                }

                document.querySelector("#" + ltrId).classList.add("cursor");
              }
              return;
            }
          });
        document
          .querySelector("#btn-audio")
          .addEventListener("click", function (e) {
            //word
            const synth = window.speechSynthesis;
            const utterThis = new SpeechSynthesisUtterance(word);

            synth.speak(utterThis);
            //change target or focus to cursor....
            document.querySelector("#btn-audio").blur();
            document.querySelector("#ltr-" + focusPos).focus();
          });
      });

      // after each key press, complete update to output div....

      //FUNCTIONS -------------
      function updateOutput(inputId, outputBoxId, newValue) {
        //for each div within the outputBox id... that has class letter, change the textContent

        let letterElems = document
          .querySelector("#" + outputBoxId)
          .querySelectorAll(".letter");
        //console.log(letterElems);

        for (let i = 0; i < letterElems.length; i++) {
          //
          let ltrId = letterElems[i].id;
          //console.log(ltrId);
          document.querySelector("#" + ltrId).textContent = newValue[i];
        }
        return;
      }

      //Function - REMOVE ALL CURSOR CLASS
      function removeAllCursor(outputBoxId) {
        let letterElems = document
          .querySelector("#" + outputBoxId)
          .querySelectorAll(".letter");

        for (let i = 0; i < letterElems.length; i++) {
          //

          letterElems[i].classList.remove("cursor");
        }

        return;
      }

      function removeRightAndWrong(outputBoxId) {
        //
        let letterElems = document
          .querySelector("#" + outputBoxId)
          .querySelectorAll(".letter");

        for (let i = 0; i < letterElems.length; i++) {
          //

          letterElems[i].classList.remove("wrong");
          letterElems[i].classList.remove("correct");
        }
        return;
      }

      function addRightAndWrong(val, outputBoxId, wordObj) {
        //
        let letterElems = document
          .querySelector("#" + outputBoxId)
          .querySelectorAll(".letter");

        for (let i = 0; i < letterElems.length; i++) {
          //***Once the length is past the val length, stop
          if (i > val.length) {
            //return early if longer than text in inputbox.
            return;
          }
          if (letterElems[i].textContent == wordObj[i]) {
            letterElems[i].classList.add("correct");
          } else {
            letterElems[i].classList.add("wrong");
          }
        }
        return;
      }

      //1-- add and remove right and wrong to output-box
      //2-- make code useable for cellphone - DONE
      //3-- have multiple questions...
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Typing 12</title>
    <style>
      :root {
        --light-grey: #ddd;
        --light-blue: #ccf;
        --dark-grey: #222;
        --light-green: #7c8;
        --light-red: #c76;
      }
      .cursor {
        border: solid 4px blue;
        border-radius: 8px;
      }

      @media (max-width: 500px) {
        body {
          background-color: blue;
          color: white;
        }
        .inp {
          min-width: 90%;
          padding: 10px;
          margin: 5px auto;
          font-size: 18px;
        }
        .btn {
          min-width: 90%;
          padding: 10px;
          margin: 5px;
          font-size: 18px;
          border-radius: 10px;
        }
        .cursor {
          border: solid 4px orange;
          border-radius: 8px;
        }
      }

      .letter {
        font-size: 18px;

        min-width: 10px;
        min-height: 20px;
        margin: 2px;
        padding: 5px;
        border-radius: 4px;
        background-color: var(--light-grey);
        color: var(--dark-grey);
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .letter:focus {
        border: 4px solid gold;
      }
      .all-box {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .main-0 {
        width: 100%;
        height: 100%;
        padding: 5px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .slides-1 {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;

        padding: 10px;
      }
      .output-box {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        margin: 5px 20px;
      }
      .inp {
        min-width: 90%;
        margin: 5px auto;
        padding: 2px;
        border-radius: 5px;
      }
      .inp:focus {
        border: solid 3px gold;
        outline: solid 2px #750;
      }
      select {
        padding: 2px;
        margin: 2px;
      }

      .correct {
        background-color: var(--light-green);
      }
      .wrong {
        background-color: var(--light-red);
      }
      .hide {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="all-box" class="all-box">
      <!--IN GOLANG... or all HTML.. yes-->
      <div id="main-0" class="main-0">
        Main menu
        <select id="select-0"></select>
        <button id="btn-start" class="btn" type="submit">Start</button>
      </div>
      <div id="slides-1" class="slides-1 hide">
        Slides, Hint: Click the audio button and listen.
        <div class="output-box" id="output-box"></div>
        <input type="text" id="inp-1" class="inp" />
        <button class="btn" id="btn-audio" type="submit">Play Audio</button>
        <button class="btn hide" id="btn-next" type="submit">Next</button>
        <button class="btn hide" id="btn-done" type="submit">Done</button>
      </div>
    </div>
    <script>
      const sentenceSetsObj = {
        1: {
          0: "a",
          1: "b",
          2: "c",
        },
        2: {
          0: "hello",
          1: "bye",
          2: "congrats",
        },
        3: {
          0: "These are long sentences.",
          1: "Are you able to see all the letters?",
          2: "Can you see the keyboard at the same time?",
        },
      };
      let slidesObj = {
        0: "a",
        1: "b",
        2: "c",
      };
      let currSlide = 0;
      let word = "";
      let wordObj = {};
      let correctObj = { correct: false };

      document.addEventListener("DOMContentLoaded", function (e) {
        //0--build word object
        //REFACTOR... onload, call the load slide function....

        //ON LOADED, fill select with keys for sentenceSetsObj
        let setKeys = Object.keys(sentenceSetsObj);
        let selectElem = document.querySelector("#select-0");
        for (let i = 0; i < setKeys.length; i++) {
          //
          let opt = document.createElement("option");
          opt.setAttribute("id", "opt-0_" + (i + 1));
          opt.value = i + 1;
          opt.text = "Activity: " + (i + 1);
          selectElem.add(opt);
        }

        //

        document
          .querySelector("#inp-1")
          .addEventListener("textInput", function (e) {
            //-- check if keykode is 0 or 229.
            //check if last character entered, at current position, is the same as the letter at position in target phrase
            //1--get letter.
            console.log(`e.data: ${e.data}`);

            //

            //

            let index = this.selectionStart;
            let indexEnd = this.selectionEnd;

            if (index > indexEnd) {
              let tmpNum = index;
              index = indexEnd;
              indexEnd = tmpNum;
            }
            let iDiff = Math.abs(index - indexEnd);
            console.log(iDiff);

            let isTooLongIndex = false;
            let ltr = "";
            let ltrId = "";
            let val = document.querySelector("#inp-1").value;
            if (index < Object.keys(wordObj).length) {
              ltr = wordObj[index];
              console.log(wordObj[index]);
              ltrId = "ltr-" + index;
            } else {
              isTooLongIndex = true;
            }

            //
            if (isTooLongIndex) {
              e.preventDefault();
              updateOutput("inp-1", "output-box", val);
              removeRightAndWrong("output-box");
              addRightAndWrong(val, "output-box", wordObj);
              console.log("exiting");
              return;
            }
            if (iDiff > 0) {
              val = val.slice(0, index) + val.slice(indexEnd, val.length);
              console.log(val);
            }
            //if val == length of wordObj, do not allow new val to be created...

            let newVal =
              val.slice(0, index) + e.data + val.slice(index, val.length);
            console.log(newVal);
            if (newVal.length > Object.keys(wordObj).length) {
              e.preventDefault();
              return;
            }
            updateOutput("inp-1", "output-box", newVal);
            removeRightAndWrong("output-box");
            addRightAndWrong(val, "output-box", wordObj);
            checkSentenceCorrect(correctObj, "output-box");

            if (index + 1 <= Object.keys(wordObj).length) {
              if (index + 1 == Object.keys(wordObj).length) {
                //cursor does not change
              } else {
                // you can change the cursor
                removeAllCursor("output-box");
                let newLtrId = "ltr-" + String(index + 1);
                document.querySelector("#" + newLtrId).classList.add("cursor");
              }

              //IF CORRECT, show the next button and an alert or colour change to background..
              if (correctObj.correct) {
                document.querySelector("#btn-next").classList.remove("hide");
              }
            } else {
              //preventDefault... adding text to input? or clear input...
              e.preventDefault();
              alert("prevent default");
              alert(
                `index: ${index} wordObj.length ${Object.keys(wordObj).length}`
              );
            }
          });
        //detect a backspace or other key
        document
          .querySelector("#inp-1")
          .addEventListener("keydown", function (e) {
            //alert(`key: ${e.key},  code: ${e.code} `);
            console.log(`e.key: ${e.key}`);
            console.log("start: " + this.selectionStart);
            console.log("end: " + this.selectionEnd);

            let val = document.querySelector("#inp-1").value;

            //DONE - responds to android e.key and e.data
            if (String(e.key).length > 1) {
              //if e.key is longer than 1 length, do not update value... exit
              //if it is a backspace, refresh cursor and output, remove a letter at cursor
              if (e.key == "Backspace") {
                let newVal = "";
                let index = this.selectionStart;
                let indexEnd = this.selectionEnd;

                if (index > indexEnd) {
                  let tmpNum = index;
                  index = indexEnd;
                  indexEnd = tmpNum;
                }
                let iDiff = Math.abs(index - indexEnd);

                if (val.length > 0) {
                  if (indexEnd == val.length && iDiff == 0) {
                    newVal = val.slice(0, indexEnd - 1);
                    console.log(newVal);
                  } else if (index == indexEnd) {
                    console.log(
                      `hey 2, indexEnd: ${indexEnd} , valLength: ${val.length}`
                    );
                    //IF INDEX and INDEX END ARE THE SAME
                    newVal =
                      val.slice(0, index - 1) + val.slice(indexEnd, val.length);
                    console.log(newVal);
                  } else {
                    console.log("iDiff:" + iDiff);
                    console.log(
                      `hey 3, indexEnd: ${indexEnd} , valLength: ${val.length}`
                    );
                    //IF INDEX and INDEX END ARE not THE SAME
                    newVal =
                      val.slice(0, index) + val.slice(indexEnd, val.length);
                    console.log(newVal);
                  }

                  updateOutput("inp-1", "output-box", newVal);
                  removeRightAndWrong("output-box");
                  addRightAndWrong(val, "output-box", wordObj);

                  if (this.selectionStart >= word.length) {
                    ltrId = "ltr-" + Number(this.selectionStart - 1);
                    //alert("a");
                  } else if (iDiff > 0) {
                    //
                    ltrId = "ltr-" + Number(this.selectionStart);
                    //alert("b");
                  } else {
                    ltrId = "ltr-" + this.selectionStart;
                    //alert("c");
                  }

                  removeAllCursor("output-box");
                  let newLtrId = ltrId;
                  if (index > 0 && iDiff > 0) {
                    newLtrId = "ltr-" + String(this.selectionStart);
                  } else if (index > 0 && iDiff == 0) {
                    //
                    newLtrId = "ltr-" + String(this.selectionStart - 1);
                  }
                  document
                    .querySelector("#" + newLtrId)
                    .classList.add("cursor");
                }
                //b-- move cursor back 1
              } else if (e.key == "ArrowLeft") {
                //... get current position and move the position one back
                let index = this.selectionStart;
                let ltrId = "ltr-" + String(index);
                let newLtrId = ltrId;
                if (index > 0) {
                  //
                  newLtrId = "ltr-" + String(index - 1);
                }

                removeAllCursor("output-box");

                document.querySelector("#" + newLtrId).classList.add("cursor");
              } else if (e.key == "ArrowRight") {
                //... get current position and move the position one back
                let index = this.selectionStart;
                let ltrId = "ltr-" + String(index);
                let newLtrId = ltrId;
                if (index < word.length - 1 && index < val.length) {
                  //DONE... IF it is the last letter in val.. only this far....
                  newLtrId = "ltr-" + String(index + 1);
                  removeAllCursor("output-box");

                  document
                    .querySelector("#" + newLtrId)
                    .classList.add("cursor");
                }
              } else if (e.key == "ArrowUp") {
                //Go to index 0 of the outputbox...
                //
                removeAllCursor("output-box");
                ltrId = "ltr-0";
                document.querySelector("#" + ltrId).classList.add("cursor");
              } else if (e.key == "ArrowDown") {
                //Go to index after last val digit
                //
                removeAllCursor("output-box");
                if (val.length >= word.length) {
                  ltrId = "ltr-" + Number(val.length - 1);
                } else {
                  ltrId = "ltr-" + val.length;
                }

                document.querySelector("#" + ltrId).classList.add("cursor");
              }
              return;
            }
          });

        //start button - BUTTONS
        document
          .querySelector("#btn-start")
          .addEventListener("click", function (e) {
            //

            //1--hide main menu
            document.querySelector("#main-0").classList.remove("hide");
            document.querySelector("#main-0").classList.add("hide");
            //2--show slides
            document.querySelector("#slides-1").classList.remove("hide");
            //load correct word from setences
            let choice = document.querySelector("#select-0").value;

            slidesObj = {};
            slidesObj = sentenceSetsObj[choice];

            //3-- load correct slide
            wordObj = {};
            word = slidesObj[currSlide];
            for (let i = 0; i < word.length; i++) {
              //
              wordObj[i] = word[i];
            }
            console.log(wordObj);
            //1--word loaded to screen
            loadSlide(currSlide, word);

            document.querySelector("#ltr-0").classList.add("cursor");
            document.querySelector("#inp-1").focus();
            //2--on key press down, letter added and css for correct or false letter added
            //const regex = /^[a-zA-z0-9"!@#$%^&*()-_+=,./<>?|`\s]/;
            //ensure it has only the specified characters...
            const regex = /^[^a-zA-Z0-9,.;:'"!@#$%^&*()-_+=\s]+$/;
          });
        document
          .querySelector("#btn-audio")
          .addEventListener("click", function (e) {
            //word
            const synth = window.speechSynthesis;
            const utterThis = new SpeechSynthesisUtterance(word);

            synth.speak(utterThis);
            //change target or focus to cursor....
            document.querySelector("#btn-audio").blur();
            document.querySelector("#inp-1").focus();
          });

        document
          .querySelector("#btn-next")
          .addEventListener("click", function (e) {
            //
            //refresh all elements.. augment or increment the currSlide value, if
            //it is the max number of slides or pages..
            //1-- increment currSlide counter
            let slideKeys = Object.keys(slidesObj);
            if (currSlide < slideKeys.length - 1) {
              //
              currSlide++;
            } else {
              //hide the next button and show the done button
              document.querySelector("#btn-next").classList.remove("hide");
              document.querySelector("#btn-next").classList.add("hide");
              document.querySelector("#btn-done").classList.remove("hide");
              return;
            }

            //2-- load new word
            word = slidesObj[currSlide];
            wordObj = {};

            for (let i = 0; i < word.length; i++) {
              //
              wordObj[i] = word[i];
            }

            //4-- empty output div
            //5-- add new divs for letters...
            loadSlide(currSlide, word);

            //3-- hide next button (load slide)
            document.querySelector("#btn-next").classList.remove("hide");
            document.querySelector("#btn-next").classList.add("hide");
            //2b -- clear the input
            document.querySelector("#btn-audio").focus();
            document.querySelector("#inp-1").value = "";
            //6-reset is correct
            correctObj.correct = false;
          });

        document
          .querySelector("#btn-done")
          .addEventListener("click", function (e) {
            //go to main menu - DONE
            document.querySelector("#slides-1").classList.remove("hide");
            document.querySelector("#slides-1").classList.add("hide");
            document.querySelector("#main-0").classList.remove("hide");
            document.querySelector("#btn-done").classList.remove("hide");
            document.querySelector("#btn-done").classList.add("hide");
            document.querySelector("#inp-1").value = "";
            correctObj.correct = false;
            currSlide = 0;
            word = "";
            wordObj = {};
            //reset everything, except store, completed...
            //_____________
          });
      });

      // after each key press, complete update to output div....

      //FUNCTIONS -------------
      function updateOutput(inputId, outputBoxId, newValue) {
        //for each div within the outputBox id... that has class letter, change the textContent

        let letterElems = document
          .querySelector("#" + outputBoxId)
          .querySelectorAll(".letter");
        //console.log(letterElems);

        for (let i = 0; i < letterElems.length; i++) {
          //
          let ltrId = letterElems[i].id;
          //console.log(ltrId);
          document.querySelector("#" + ltrId).textContent = newValue[i];
        }
        return;
      }

      //Function - REMOVE ALL CURSOR CLASS
      function removeAllCursor(outputBoxId) {
        let letterElems = document
          .querySelector("#" + outputBoxId)
          .querySelectorAll(".letter");

        for (let i = 0; i < letterElems.length; i++) {
          //

          letterElems[i].classList.remove("cursor");
        }

        return;
      }

      function removeRightAndWrong(outputBoxId) {
        //
        let letterElems = document
          .querySelector("#" + outputBoxId)
          .querySelectorAll(".letter");

        for (let i = 0; i < letterElems.length; i++) {
          //

          letterElems[i].classList.remove("wrong");
          letterElems[i].classList.remove("correct");
        }
        return;
      }

      function addRightAndWrong(val, outputBoxId, wordObj) {
        //
        let letterElems = document
          .querySelector("#" + outputBoxId)
          .querySelectorAll(".letter");

        for (let i = 0; i < letterElems.length; i++) {
          //***Once the length is past the val length, stop
          if (i > val.length) {
            //return early if longer than text in inputbox.
            return;
          }
          if (letterElems[i].textContent == wordObj[i]) {
            letterElems[i].classList.add("correct");
          } else {
            letterElems[i].classList.add("wrong");
          }
        }
        return;
      }

      function checkSentenceCorrect(correctObj, outputBoxId) {
        // - for each div with letter class, check it has the correct class,
        // //if yes, show the next button...(or if 80% of letters are correct)
        let letterElems = document
          .querySelector("#" + outputBoxId)
          .querySelectorAll(".letter");

        let letterCount = letterElems.length;
        let count = 0;
        let isCorrect = false;

        for (let i = 0; i < letterElems.length; i++) {
          //
          isCorrect = letterElems[i].classList.contains("correct");
          if (isCorrect) {
            count++;
          }
        }
        if (count / letterCount > 0.8) {
          //
          correctObj.correct = true;
        }

        return;
      }

      //Function - Load Slide
      function loadSlide(slide, word) {
        //

        document.querySelector("#output-box").innerHTML = "";
        let outputDiv = document.querySelector("#output-box");
        for (let i = 0; i < word.length; i++) {
          //

          let letterDiv = document.createElement("div");
          letterDiv.setAttribute("id", "ltr-" + i);

          letterDiv.classList.add("letter");
          //

          outputDiv.appendChild(letterDiv);
        }

        return;
      }

      //3-- have multiple questions...
    </script>
  </body>
</html>
